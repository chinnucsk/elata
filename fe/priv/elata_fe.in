#!/bin/sh
#
#   Copyright (c) 2011, Nokia Corporation
#   All Rights Reserved.
#
#   The contents of this file are subject to the 3-clause BSD License,
#   (the "License"); you may not use this file except in compliance 
#   with the License. You should have received a copy of the 3-clause
#   BSD Licensee along with this software. 
#
#   Software distributed under the License is distributed on an "AS IS"
#   basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See
#   the License for the specific language governing rights and limitations
#   under the License.
#

ROOT=`pwd`
ERTS=`ls $ROOT | grep erts`
ERL=$ROOT/$ERTS/bin/erl
sed s:%FINAL_ROOTDIR%:$ROOT: $ROOT/$ERTS/bin/erl.src > $ROOT/$ERTS/bin/erl

# Validate presence of external 3rd party javascript library
if [ ! -f $ROOT/lib/@PKG@-@VSN@/priv/webapp/bert.js ] ; then
	echo "bert.js is not found, obtain a copy from github.org";
	echo "git clone https://github.com/bbrowning/BERT-JS.git";
	echo "cp BERT-JS/bert.js $ROOT/lib/@PKG@-@VSN@/priv/webapp/";
fi

if [ ! -f $ROOT/lib/@PKG@-@VSN@/priv/webapp/mootools-core-1.3.2-full-compat-yc.js ] ; then
   echo "mootool is not found, obtain a copy from mootool.net";
   echo "curl -O http://mootools.net/download/get/mootools-core-1.3.2-full-compat-yc.js";
   echo "cp mootools-core-1.3.2-full-compat-yc.js $ROOT/lib/@PKG@-@VSN@/priv/webapp/";
fi   

#$ERL -sname @PKG@ -detached \
#   -boot   $ROOT/releases/@VSN@/start \
#   -config $ROOT/lib/@PKG@-@VSN@/priv/sys
   
LOGDIR=$ROOT/logs
test -d $LOGDIR || mkdir -p $LOGDIR

PIPEDIR=$ROOT/run
test -d $PIPEDIR || mkdir -p $PIPEDIR

SCRIPT=`basename $0`

TOERL=$ROOT/$ERTS/bin/to_erl
RUNERL=$ROOT/$ERTS/bin/run_erl

case "$1" in
    start)
        if [ "$(ls -A $PIPEDIR)" ]; then
            echo "Front-end is already running"
	else
            $RUNERL -daemon $PIPEDIR/ $LOGDIR/ \
                "$ERL -sname @PKG@ \
                -boot $ROOT/releases/@VSN@/start \
                -config $ROOT/lib/@PKG@-@VSN@/priv/sys"
            echo "OK"
        fi
        ;;

    stop)
        if [ "$(ls -A $PIPEDIR)" ]; then
            echo 'q().' | $TOERL $PIPEDIR/ 2>/dev/null
            echo "OK"
        else
            echo "Front-end is not running"
        fi
        ;;

    attach)
        if [ "$(ls -A $PIPEDIR)" ]; then
	    exec $TOERL $PIPEDIR/
        else
            echo "Front-end is not running"
        fi
        ;;

    *)
        echo "Usage: $SCRIPT {start|stop|attach}"
        exit 1
        ;;
esac

exit 0
